# Загрузка системы

## Введение

Копируем Vagrantfile в директорию на компьютере.

## Запуск тестового окружения

Открываем консоль, перейдим в директорию с проектом и выполнить `vagrant up`
```shell
cd otus-hw6
vagrant up
```

## Подключение к серверу

Для подключения к серверу необходимо выполнить
```shell
vagrant ssh lvm
```

# Задание 1 Попасть в систему несколькими способами

### Для получения доступа необходимо открыть GUI Vurtual Box (или другой системы виртуализации) или добежать до серверной комнаты и подключить монитор с мышкой к серверу. 
### Запустить или перезагрузить машину и при выборе ядра для загрузки нажать "е" - edit. Попадаем в окно где мы можем изменить параметры загрузки.

## Способ 1

```shell
init=/bin/sh
```

1. В конце строки начинающейся с Linix16 добавляем init=/bin/sh и нажимаем ctrl-x для зугрузки в систему.
2. На этом все, мы попали в систему.
3. Перемонтируем в режим Read-Write
```shell
mount -o remount,rw /
```
4. После чего можно записать данные в любой файл
```shell
mount | grep root
```

## Способ 2

1. В строке начинающейся с Linix16 находим значение "ro" и меняем его на "rw init=/sysroot/bin/sh"
2. Теперь нажимаем "Ctrl + X" и входим в аварийный режим
3. Выполнаем команду 
```shell
chroot /sysroot
```
4. Менаем пароль выполнив
```shell
passwd root
```
5. После этого, обновляем параметры SELinux командой
```shell
touch /.autorelabel
```
6. Готово! Перезагружаемся командой reboot и загружаемся в штатном режиме. Пароль от root будет изменен.

## Способ 3

1. В конце строки начинающейся с Linix16 добавляем "rd.break"
2. Теперь нажимаем "Ctrl + X" и входим в аварийный режим
3. Выполнаем команду 
```shell
mount -o remount,rw /sysroot
```
```shell
chroot /sysroot
```
```shell
passwd root
```
```shell
touch /.autorelabel
```
4. Готово! Перезагружаемся командой reboot и загружаемся в штатном режиме. Пароль от root будет изменен.

# Задание 2 Установить систему с LVM, после чего переименовать VG

Посмотрим текущее состояние системы
```shell
vgs
```
<details><summary>Пример вывода</summary>
<p>

```log
[root@lvm /]# vgs
  VG         #PV #LV #SN Attr   VSize   VFree
  VolGroup00   1   2   0 wz--n- <38.97g    0
```
</p>
</details>

Переименовываем
```shell
vgrename VolGroup00 OtusRoot
```
<details><summary>Пример вывода</summary>
<p>

```log
[root@lvm /]# vgrename VolGroup00 OtusRoot
  Volume group "VolGroup00" successfully renamed to "OtusRoot"
  
[root@lvm /]# vgs
  VG       #PV #LV #SN Attr   VSize   VFree
  OtusRoot   1   2   0 wz--n- <38.97g    0  
```
</p>
</details>

Редактируем /etc/fstab
```shell
vi /etc/fstab
```
<details><summary>Пример вывода</summary>
<p>

```log
# /etc/fstab
# Created by anaconda on Sat May 12 18:50:26 2018
#
# Accessible filesystems, by reference, are maintained under '/dev/disk'
# See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info
#
/dev/mapper/OtusRoot-LogVol00 /                       xfs     defaults        0 0
UUID=570897ca-e759-4c81-90cf-389da6eee4cc /boot                   xfs     defaults        0 0
/dev/mapper/OtusRoot-LogVol01 swap                    swap    defaults        0 0
#VAGRANT-BEGIN
# The contents below are automatically generated by Vagrant. Do not modify.
#VAGRANT-END
```
</p>
</details>

Редактируем /etc/default/grub
```shell
vi /etc/default/grub
```

<details><summary>Пример вывода</summary>
<p>

```log
GRUB_TIMEOUT=1
GRUB_DISTRIBUTOR="$(sed 's, release .*$,,g' /etc/system-release)"
GRUB_DEFAULT=saved
GRUB_DISABLE_SUBMENU=true
GRUB_TERMINAL_OUTPUT="console"
GRUB_CMDLINE_LINUX="no_timer_check console=tty0 console=ttyS0,115200n8 net.ifnames=0 biosdevname=0 elevator=noop crashkernel=auto rd.lvm.lv=OtusRoot/LogVol00 rd.lvm.lv=OtusRoot/LogVol01 rhgb quiet"
GRUB_DISABLE_RECOVERY="true"
```
</p>
</details>

Редактируем /boot/grub2/grub.cfg
```shell
vi /boot/grub2/grub.cfg
```

<details><summary>Пример вывода</summary>
<p>

```log
### BEGIN /etc/grub.d/10_linux ###
menuentry 'CentOS Linux (3.10.0-862.2.3.el7.x86_64) 7 (Core)' --class centos --class gnu-linux --class gnu --class os --unrestricted $menuentry_id_option 'gnulinux-3.10.0-862.2.3.el7.x86_64-advanced-b60e9498-0baa-4d9f-90aa-069048217fee' {
        load_video
        set gfxpayload=keep
        insmod gzio
        insmod part_msdos
        insmod xfs
        set root='hd0,msdos2'
        if [ x$feature_platform_search_hint = xy ]; then
          search --no-floppy --fs-uuid --set=root --hint='hd0,msdos2'  570897ca-e759-4c81-90cf-389da6eee4cc
        else
          search --no-floppy --fs-uuid --set=root 570897ca-e759-4c81-90cf-389da6eee4cc
        fi
        linux16 /vmlinuz-3.10.0-862.2.3.el7.x86_64 root=/dev/mapper/OtusRoot-LogVol00 ro no_timer_check console=tty0 console=ttyS0,115200n8 net.ifnames=0 biosdevname=0 elevator=noop crashkernel=auto rd.lvm.lv=VolGroup00/LogVol00 rd.lvm.lv=VolGroup00/LogVol01 rhgb quiet
        initrd16 /initramfs-3.10.0-862.2.3.el7.x86_64.img
}
if [ "x$default" = 'CentOS Linux (3.10.0-862.2.3.el7.x86_64) 7 (Core)' ]; then default='Advanced options for CentOS Linux>CentOS Linux (3.10.0-862.2.3.el7.x86_64) 7 (Core)'; fi;
### END /etc/grub.d/10_linux ###
```
</p>
</details>

Пересоздаем initrd image

```shell
 mkinitrd -f -v /boot/initramfs-$(uname -r).img $(uname -r)
```

<details><summary>Пример вывода</summary>
<p>

```log
Executing: /sbin/dracut -f -v /boot/initramfs-3.10.0-862.2.3.el7.x86_64.img 3.10.0-862.2.3.el7.x86_64
dracut module 'busybox' will not be installed, because command 'busybox' could not be found!
dracut module 'crypt' will not be installed, because command 'cryptsetup' could not be found!
dracut module 'dmraid' will not be installed, because command 'dmraid' could not be found!
dracut module 'dmsquash-live-ntfs' will not be installed, because command 'ntfs-3g' could not be found!
dracut module 'multipath' will not be installed, because command 'multipath' could not be found!
dracut module 'busybox' will not be installed, because command 'busybox' could not be found!
dracut module 'crypt' will not be installed, because command 'cryptsetup' could not be found!
dracut module 'dmraid' will not be installed, because command 'dmraid' could not be found!
dracut module 'dmsquash-live-ntfs' will not be installed, because command 'ntfs-3g' could not be found!
dracut module 'multipath' will not be installed, because command 'multipath' could not be found!
*** Including module: bash ***
*** Including module: nss-softokn ***
*** Including module: i18n ***
*** Including module: drm ***
*** Including module: plymouth ***
*** Including module: dm ***
Skipping udev rule: 64-device-mapper.rules
Skipping udev rule: 60-persistent-storage-dm.rules
Skipping udev rule: 55-dm.rules
*** Including module: kernel-modules ***
Omitting driver floppy
*** Including module: lvm ***
Skipping udev rule: 64-device-mapper.rules
Skipping udev rule: 56-lvm.rules
Skipping udev rule: 60-persistent-storage-lvm.rules
*** Including module: qemu ***
*** Including module: resume ***
*** Including module: rootfs-block ***
*** Including module: terminfo ***
*** Including module: udev-rules ***
Skipping udev rule: 40-redhat-cpu-hotplug.rules
Skipping udev rule: 91-permissions.rules
*** Including module: biosdevname ***
*** Including module: systemd ***
*** Including module: usrmount ***
*** Including module: base ***
*** Including module: fs-lib ***
*** Including module: shutdown ***
*** Including modules done ***
*** Installing kernel module dependencies and firmware ***
*** Installing kernel module dependencies and firmware done ***
*** Resolving executable dependencies ***
*** Resolving executable dependencies done***
*** Hardlinking files ***
*** Hardlinking files done ***
*** Stripping files ***
*** Stripping files done ***
*** Generating early-microcode cpio image contents ***
*** No early-microcode cpio image needed ***
*** Store current command line parameters ***
*** Creating image file ***
*** Creating image file done ***
*** Creating initramfs image file '/boot/initramfs-3.10.0-862.2.3.el7.x86_64.img' done ***
```
</p>
</details>

Перезагружаемся!

```shell
vgs
```

<details><summary>Пример вывода</summary>
<p>

```log
[root@lvm /]# vgs
  VG       #PV #LV #SN Attr   VSize   VFree
  OtusRoot   1   2   0 wz--n- <38.97g    0  
```
</p>
</details>

# Задание 3 Добавить модуль в initrd

Создаем папку с именем 01test в каталоге /usr/lib/dracut/modules.d/

```shell
mkdir /usr/lib/dracut/modules.d/01test
```

<details><summary>Пример вывода</summary>
<p>

```log
[root@lvm etc]# ls -l /usr/lib/dracut/modules.d/
total 8
drwxr-xr-x. 2 root root   29 May 12  2018 00bash
drwxr-xr-x. 2 root root   29 May 12  2018 00systemd-bootchart
drwxr-xr-x. 2 root root    6 Dec 10 05:57 01test
drwxr-xr-x. 2 root root   57 May 12  2018 03modsign
drwxr-xr-x. 2 root root   29 May 12  2018 03rescue
drwxr-xr-x. 2 root root   72 May 12  2018 04watchdog
drwxr-xr-x. 2 root root   29 May 12  2018 05busybox
drwxr-xr-x. 2 root root   29 May 12  2018 05nss-softokn
drwxr-xr-x. 2 root root  111 May 12  2018 10i18n
drwxr-xr-x. 2 root root   72 May 12  2018 30convertfs
drwxr-xr-x. 2 root root   47 May 12  2018 45url-lib
drwxr-xr-x. 2 root root   29 May 12  2018 50drm
drwxr-xr-x. 2 root root  150 May 12  2018 50plymouth
drwxr-xr-x. 2 root root   92 May 12  2018 80cms
drwxr-xr-x. 2 root root   29 May 12  2018 90bcache
drwxr-xr-x. 2 root root  129 May 12  2018 90btrfs
drwxr-xr-x. 2 root root  195 May 12  2018 90crypt
drwxr-xr-x. 2 root root  130 May 12  2018 90dm
drwxr-xr-x. 2 root root   93 May 12  2018 90dmraid
drwxr-xr-x. 2 root root  258 May 12  2018 90dmsquash-live
drwxr-xr-x. 2 root root   29 May 12  2018 90dmsquash-live-ntfs
drwxr-xr-x. 2 root root   73 May 12  2018 90kernel-modules
drwxr-xr-x. 2 root root   88 May 12  2018 90lvm
drwxr-xr-x. 2 root root 4096 May 12  2018 90mdraid
drwxr-xr-x. 2 root root  110 May 12  2018 90multipath
drwxr-xr-x. 2 root root   29 May 12  2018 90multipath-hostonly
drwxr-xr-x. 2 root root   29 May 12  2018 90qemu
drwxr-xr-x. 2 root root   53 May 12  2018 91crypt-gpg
drwxr-xr-x. 2 root root   54 May 12  2018 91crypt-loop
drwxr-xr-x. 2 root root   50 May 12  2018 95dasd
drwxr-xr-x. 2 root root   54 May 12  2018 95dasd_mod
drwxr-xr-x. 2 root root   29 May 12  2018 95debug
drwxr-xr-x. 2 root root   49 May 12  2018 95fstab-sys
drwxr-xr-x. 2 root root   69 May 12  2018 95resume
drwxr-xr-x. 2 root root  120 May 12  2018 95rootfs-block
drwxr-xr-x. 2 root root   29 May 12  2018 95terminfo
drwxr-xr-x. 2 root root  122 May 12  2018 95udev-rules
drwxr-xr-x. 2 root root  102 May 12  2018 95virtfs
drwxr-xr-x. 2 root root   50 May 12  2018 95zfcp
drwxr-xr-x. 2 root root   57 May 12  2018 97biosdevname
drwxr-xr-x. 2 root root   68 May 12  2018 98ecryptfs
drwxr-xr-x. 2 root root   49 May 12  2018 98pollcdrom
drwxr-xr-x. 2 root root   58 May 12  2018 98selinux
drwxr-xr-x. 2 root root  191 May 12  2018 98syslog
drwxr-xr-x. 2 root root 4096 May 12  2018 98systemd
drwxr-xr-x. 2 root root   49 May 12  2018 98usrmount
drwxr-xr-x. 2 root root  173 May 12  2018 99base
drwxr-xr-x. 2 root root   46 May 12  2018 99fs-lib
drwxr-xr-x. 2 root root   47 May 12  2018 99img-lib
drwxr-xr-x. 2 root root   48 May 12  2018 99shutdown
```
</p>
</details>

В нее поместим два скрипта module-setup.sh и test.sh

```shell
cat >module-setup.sh<<E0F
#!/bin/bash

check() {
    return 0
}

depends() {
    return 0
}

install() {
    inst_hook cleanup 00 "${moddir}/test.sh"
}
E0F
```

<details><summary>Пример вывода</summary>
<p>

```log
[root@lvm 01test]# cat ./module-setup.sh
#!/bin/bash

check() {
    return 0
}

depends() {
    return 0
}

install() {
    inst_hook cleanup 00 "${moddir}/test.sh"
}
```
</p>
</details>

Делаем его исполняемым 

```shell
chmod +x module-setup.sh
```

Создаем test.sh

<details><summary>Пример вывода</summary>
<p>

```log
#!/bin/bash

exec 0<>/dev/console 1<>/dev/console 2<>/dev/console
cat <<'msgend'
Hello! You are in dracut module!
 ___________________
< I'm dracut module >
 -------------------
   \
    \
        .--.
       |o_o |
       |:_/ |
      //   \ \
     (|     | )
    /'\_   _/`\
    \___)=(___/
msgend
sleep 10
echo " continuing...."
```
</p>
</details>

Делаем его исполняемым 

```shell
chmod +x test.sh
```

Пересоздаем initrd image

```shell
 mkinitrd -f -v /boot/initramfs-$(uname -r).img $(uname -r)
```

<details><summary>Пример вывода</summary>
<p>

```log
Executing: /sbin/dracut -f -v /boot/initramfs-3.10.0-862.2.3.el7.x86_64.img 3.10.0-862.2.3.el7.x86_64
dracut module 'busybox' will not be installed, because command 'busybox' could not be found!
dracut module 'crypt' will not be installed, because command 'cryptsetup' could not be found!
dracut module 'dmraid' will not be installed, because command 'dmraid' could not be found!
dracut module 'dmsquash-live-ntfs' will not be installed, because command 'ntfs-3g' could not be found!
dracut module 'multipath' will not be installed, because command 'multipath' could not be found!
dracut module 'busybox' will not be installed, because command 'busybox' could not be found!
dracut module 'crypt' will not be installed, because command 'cryptsetup' could not be found!
dracut module 'dmraid' will not be installed, because command 'dmraid' could not be found!
dracut module 'dmsquash-live-ntfs' will not be installed, because command 'ntfs-3g' could not be found!
dracut module 'multipath' will not be installed, because command 'multipath' could not be found!
*** Including module: bash ***
*** Including module: nss-softokn ***
*** Including module: i18n ***
*** Including module: drm ***
*** Including module: plymouth ***
*** Including module: dm ***
Skipping udev rule: 64-device-mapper.rules
Skipping udev rule: 60-persistent-storage-dm.rules
Skipping udev rule: 55-dm.rules
*** Including module: kernel-modules ***
Omitting driver floppy
*** Including module: lvm ***
Skipping udev rule: 64-device-mapper.rules
Skipping udev rule: 56-lvm.rules
Skipping udev rule: 60-persistent-storage-lvm.rules
*** Including module: qemu ***
*** Including module: resume ***
*** Including module: rootfs-block ***
*** Including module: terminfo ***
*** Including module: udev-rules ***
Skipping udev rule: 40-redhat-cpu-hotplug.rules
Skipping udev rule: 91-permissions.rules
*** Including module: biosdevname ***
*** Including module: systemd ***
*** Including module: usrmount ***
*** Including module: base ***
*** Including module: fs-lib ***
*** Including module: shutdown ***
*** Including modules done ***
*** Installing kernel module dependencies and firmware ***
*** Installing kernel module dependencies and firmware done ***
*** Resolving executable dependencies ***
*** Resolving executable dependencies done***
*** Hardlinking files ***
*** Hardlinking files done ***
*** Stripping files ***
*** Stripping files done ***
*** Generating early-microcode cpio image contents ***
*** No early-microcode cpio image needed ***
*** Store current command line parameters ***
*** Creating image file ***
*** Creating image file done ***
*** Creating initramfs image file '/boot/initramfs-3.10.0-862.2.3.el7.x86_64.img' done ***
```
</p>
</details>

Проверяем

```shell
 lsinitrd -m /boot/initramfs-$(uname -r).img | grep test
```

<details><summary>Пример вывода</summary>
<p>

```log
[root@lvm 01test]# lsinitrd -m /boot/initramfs-$(uname -r).img | grep test
test
```
</p>
</details>

Перезагружаемся.








